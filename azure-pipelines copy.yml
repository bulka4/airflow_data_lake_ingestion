# define from which branch in repo we will be deploying code
trigger:
- main
resources:
- repo: self
# define which Agent pool will be used
pool:
  name: data_engineering_apps
# define which Variable group we will use
variables:
- group: ACR-SP-credentials
stages:
# The first stage is building a Docker image and pushing it to the Azure Container Registry (ACR)
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build and push an image to container registry
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: airflow
        dockerfile: $(Build.SourcesDirectory)/Dockerfile # path to the Dockerfile in repository.
        containerRegistry: 8e3142f8-1e0a-4768-a042-43c807f9fbd0 # ID of the Service connection in DevOps linked to the ACR.
        tags: $(Build.BuildId)
# stage for pulling a Docker image on VM and running it.
- stage: Deploy
  jobs:
  - job: PullImage
    steps:
    # Bash script which will be executed on the VM.
    - script: |
        image_name=dataEngineeringApps.azurecr.io/airflow:$(Build.BuildId)

        # Set the Azure Pipeline variables as environment variables. They will be used in the docker-compose.yaml file.
        export CONTAINER_REGISTRY=dataEngineeringApps.azurecr.io
        export IMAGE_REPOSITORY=airflow
        export IMAGE_TAG=$(Build.BuildId)

        # Below arguments SP_ID and SP_PASSWORD will be taken from the DevOps Library Variable group.
        echo "Login to Docker using service principal credentials"
        docker login dataEngineeringApps.azurecr.io -u $(SP_ID) -p $(SP_PASSWORD)

        echo "Pulling the Docker image"
        docker pull $image_name

        echo "Running the Docker container"
        docker compose -f docker-compose.yaml up -d
